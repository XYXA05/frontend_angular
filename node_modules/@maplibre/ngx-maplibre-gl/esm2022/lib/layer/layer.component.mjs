import { Component, EventEmitter, Input, Output, } from '@angular/core';
import { fromEvent } from 'rxjs';
import { filter, map, startWith, switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../map/map.service";
/**
 * `mgl-layer` - a layer component
 * @see [layers](https://maplibre.org/maplibre-style-spec/layers/)
 *
 * @category Layer Component
 *
 * @example
 * ```html
 * ...
 * <mgl-map ...>
 *   <mgl-layer
 *     id="state-borders"
 *     type="line"
 *     [source]="states"
 *     [paint]="{
 *       'line-color': '#627BC1',
 *       'line-width': 2
 *     }"
 *   ></mgl-layer>
 * </mgl-map>
 * ```
 */
export class LayerComponent {
    constructor(mapService) {
        this.mapService = mapService;
        this.layerClick = new EventEmitter();
        this.layerDblClick = new EventEmitter();
        this.layerMouseDown = new EventEmitter();
        this.layerMouseUp = new EventEmitter();
        this.layerMouseEnter = new EventEmitter();
        this.layerMouseLeave = new EventEmitter();
        this.layerMouseMove = new EventEmitter();
        this.layerMouseOver = new EventEmitter();
        this.layerMouseOut = new EventEmitter();
        this.layerContextMenu = new EventEmitter();
        this.layerTouchStart = new EventEmitter();
        this.layerTouchEnd = new EventEmitter();
        this.layerTouchCancel = new EventEmitter();
        this.layerAdded = false;
    }
    ngOnInit() {
        this.sub = this.mapService.mapLoaded$
            .pipe(switchMap(() => fromEvent(this.mapService.mapInstance, 'styledata').pipe(map(() => false), filter(() => !this.mapService.mapInstance.getLayer(this.id)), startWith(true))))
            .subscribe((bindEvents) => this.init(bindEvents));
    }
    ngOnChanges(changes) {
        if (!this.layerAdded) {
            return;
        }
        if (changes.paint && !changes.paint.isFirstChange()) {
            this.mapService.setAllLayerPaintProperty(this.id, changes.paint.currentValue);
        }
        if (changes.layout && !changes.layout.isFirstChange()) {
            this.mapService.setAllLayerLayoutProperty(this.id, changes.layout.currentValue);
        }
        if (changes.filter && !changes.filter.isFirstChange()) {
            this.mapService.setLayerFilter(this.id, changes.filter.currentValue);
        }
        if (changes.before && !changes.before.isFirstChange()) {
            this.mapService.setLayerBefore(this.id, changes.before.currentValue);
        }
        if ((changes.minzoom && !changes.minzoom.isFirstChange()) ||
            (changes.maxzoom && !changes.maxzoom.isFirstChange())) {
            this.mapService.setLayerZoomRange(this.id, this.minzoom, this.maxzoom);
        }
    }
    ngOnDestroy() {
        if (this.layerAdded) {
            this.mapService.removeLayer(this.id);
            if (undefined !== this.sourceIdAdded) {
                // Clean up any automatically created source for this layer
                if (this.mapService.getSource(this.sourceIdAdded)) {
                    this.mapService.removeSource(this.sourceIdAdded);
                }
            }
        }
        if (this.sub) {
            this.sub.unsubscribe();
        }
    }
    init(bindEvents) {
        const layer = {
            layerOptions: {
                id: this.id,
                type: this.type,
                source: this.source,
                metadata: this.metadata,
                // eslint-disable-next-line @typescript-eslint/naming-convention
                'source-layer': this.sourceLayer,
                minzoom: this.minzoom,
                maxzoom: this.maxzoom,
                filter: this.filter,
                layout: this.layout,
                paint: this.paint,
            },
            layerEvents: {
                layerClick: this.layerClick,
                layerDblClick: this.layerDblClick,
                layerMouseDown: this.layerMouseDown,
                layerMouseUp: this.layerMouseUp,
                layerMouseEnter: this.layerMouseEnter,
                layerMouseLeave: this.layerMouseLeave,
                layerMouseMove: this.layerMouseMove,
                layerMouseOver: this.layerMouseOver,
                layerMouseOut: this.layerMouseOut,
                layerContextMenu: this.layerContextMenu,
                layerTouchStart: this.layerTouchStart,
                layerTouchEnd: this.layerTouchEnd,
                layerTouchCancel: this.layerTouchCancel,
            },
        };
        if (this.removeSource && typeof this.source !== 'string') {
            // There is no id of an existing source bound to this layer
            if (undefined === this.mapService.getSource(this.id)) {
                // A source with this layer id doesn't exist so it will be created automatically in the addLayer call below
                this.sourceIdAdded = this.id;
            }
        }
        this.mapService.addLayer(layer, bindEvents, this.before);
        if (undefined !== this.sourceIdAdded) {
            if (undefined === this.mapService.getSource(this.sourceIdAdded)) {
                // If it wasn't created for some reason then we don't want to clean it up
                this.sourceIdAdded = undefined;
            }
        }
        this.layerAdded = true;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: LayerComponent, deps: [{ token: i1.MapService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "17.3.1", type: LayerComponent, isStandalone: true, selector: "mgl-layer", inputs: { id: "id", source: "source", type: "type", metadata: "metadata", sourceLayer: "sourceLayer", removeSource: "removeSource", filter: "filter", layout: "layout", paint: "paint", before: "before", minzoom: "minzoom", maxzoom: "maxzoom" }, outputs: { layerClick: "layerClick", layerDblClick: "layerDblClick", layerMouseDown: "layerMouseDown", layerMouseUp: "layerMouseUp", layerMouseEnter: "layerMouseEnter", layerMouseLeave: "layerMouseLeave", layerMouseMove: "layerMouseMove", layerMouseOver: "layerMouseOver", layerMouseOut: "layerMouseOut", layerContextMenu: "layerContextMenu", layerTouchStart: "layerTouchStart", layerTouchEnd: "layerTouchEnd", layerTouchCancel: "layerTouchCancel" }, usesOnChanges: true, ngImport: i0, template: '', isInline: true }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.1", ngImport: i0, type: LayerComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'mgl-layer',
                    template: '',
                    standalone: true,
                }]
        }], ctorParameters: () => [{ type: i1.MapService }], propDecorators: { id: [{
                type: Input
            }], source: [{
                type: Input
            }], type: [{
                type: Input
            }], metadata: [{
                type: Input
            }], sourceLayer: [{
                type: Input
            }], removeSource: [{
                type: Input
            }], filter: [{
                type: Input
            }], layout: [{
                type: Input
            }], paint: [{
                type: Input
            }], before: [{
                type: Input
            }], minzoom: [{
                type: Input
            }], maxzoom: [{
                type: Input
            }], layerClick: [{
                type: Output
            }], layerDblClick: [{
                type: Output
            }], layerMouseDown: [{
                type: Output
            }], layerMouseUp: [{
                type: Output
            }], layerMouseEnter: [{
                type: Output
            }], layerMouseLeave: [{
                type: Output
            }], layerMouseMove: [{
                type: Output
            }], layerMouseOver: [{
                type: Output
            }], layerMouseOut: [{
                type: Output
            }], layerContextMenu: [{
                type: Output
            }], layerTouchStart: [{
                type: Output
            }], layerTouchEnd: [{
                type: Output
            }], layerTouchCancel: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5ZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW1hcGxpYnJlLWdsL3NyYy9saWIvbGF5ZXIvbGF5ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFJTCxNQUFNLEdBRVAsTUFBTSxlQUFlLENBQUM7QUFPdkIsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFJbkU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXFCRztBQU1ILE1BQU0sT0FBTyxjQUFjO0lBNER6QixZQUFvQixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBNUJoQyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQWtDLENBQUM7UUFDaEUsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBa0MsQ0FBQztRQUNuRSxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFrQyxDQUFDO1FBQ3BFLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQWtDLENBQUM7UUFDbEUsb0JBQWUsR0FBRyxJQUFJLFlBQVksRUFFekMsQ0FBQztRQUNNLG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBRXpDLENBQUM7UUFDTSxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFrQyxDQUFDO1FBQ3BFLG1CQUFjLEdBQUcsSUFBSSxZQUFZLEVBQWtDLENBQUM7UUFDcEUsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBa0MsQ0FBQztRQUNuRSxxQkFBZ0IsR0FBRyxJQUFJLFlBQVksRUFFMUMsQ0FBQztRQUNNLG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBRXpDLENBQUM7UUFDTSxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFrQyxD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O2dCQUVHLE1BQU07c0JBQWQsS0FBSztnQkFFRyxJQUFJO3NCQUFaLEtBQUs7Z0JBRUcsUUFBUTtzQkFBaEIsS0FBSztnQkFFRyxXQUFXO3NCQUFuQixLQUFLO2dCQU1HLFlBQVk7c0JBQXBCLEtBQUs7Z0JBR0csTUFBTTtzQkFBZCxLQUFLO2dCQUVHLE1BQU07c0JBQWQsS0FBSztnQkFFRyxLQUFLO3NCQUFiLEtBQUs7Z0JBRUcsTUFBTTtzQkFBZCxLQUFLO2dCQUVHLE9BQU87c0JBQWYsS0FBSztnQkFFRyxPQUFPO3NCQUFmLEtBQUs7Z0JBRUksVUFBVTtzQkFBbkIsTUFBTTtnQkFDRyxhQUFhO3NCQUF0QixNQUFNO2dCQUNHLGNBQWM7c0JBQXZCLE1BQU07Z0JBQ0csWUFBWTtzQkFBckIsTUFBTTtnQkFDRyxlQUFlO3NCQUF4QixNQUFNO2dCQUdHLGVBQWU7c0JBQXhCLE1BQU07Z0JBR0csY0FBYztzQkFBdkIsTUFBTTtnQkFDRyxjQUFjO3NCQUF2QixNQUFNO2dCQUNHLGFBQWE7c0JBQXRCLE1BQU07Z0JBQ0csZ0JBQWdCO3NCQUF6QixNQUFNO2dCQUdHLGVBQWU7c0JBQXhCLE1BQU07Z0JBR0csYUFBYTtzQkFBdEIsTUFBTTtnQkFDRyxnQkFBZ0I7c0JBQXpCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBMYXllclNwZWNpZmljYXRpb24sXG4gIEZpbHRlclNwZWNpZmljYXRpb24sXG4gIE1hcExheWVyTW91c2VFdmVudCxcbiAgTWFwTGF5ZXJUb3VjaEV2ZW50LFxufSBmcm9tICdtYXBsaWJyZS1nbCc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTWFwU2VydmljZSwgU2V0dXBMYXllciB9IGZyb20gJy4uL21hcC9tYXAuc2VydmljZSc7XG5pbXBvcnQgeyBFdmVudERhdGEsIExheWVyRXZlbnRzIH0gZnJvbSAnLi4vbWFwL21hcC50eXBlcyc7XG5cbi8qKlxuICogYG1nbC1sYXllcmAgLSBhIGxheWVyIGNvbXBvbmVudFxuICogQHNlZSBbbGF5ZXJzXShodHRwczovL21hcGxpYnJlLm9yZy9tYXBsaWJyZS1zdHlsZS1zcGVjL2xheWVycy8pXG4gKiBcbiAqIEBjYXRlZ29yeSBMYXllciBDb21wb25lbnRcbiAqIFxuICogQGV4YW1wbGVcbiAqIGBgYGh0bWxcbiAqIC4uLlxuICogPG1nbC1tYXAgLi4uPlxuICogICA8bWdsLWxheWVyXG4gKiAgICAgaWQ9XCJzdGF0ZS1ib3JkZXJzXCJcbiAqICAgICB0eXBlPVwibGluZVwiXG4gKiAgICAgW3NvdXJjZV09XCJzdGF0ZXNcIlxuICogICAgIFtwYWludF09XCJ7XG4gKiAgICAgICAnbGluZS1jb2xvcic6ICcjNjI3QkMxJyxcbiAqICAgICAgICdsaW5lLXdpZHRoJzogMlxuICogICAgIH1cIlxuICogICA+PC9tZ2wtbGF5ZXI+XG4gKiA8L21nbC1tYXA+XG4gKiBgYGBcbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbWdsLWxheWVyJyxcbiAgdGVtcGxhdGU6ICcnLFxuICBzdGFuZGFsb25lOiB0cnVlLFxufSlcbmV4cG9ydCBjbGFzcyBMYXllckNvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMsIExheWVyRXZlbnRzIHtcbiAgLyoqIEluaXQgaW5wdXQgKi9cbiAgQElucHV0KCkgaWQ6IExheWVyU3BlY2lmaWNhdGlvblsnaWQnXTtcbiAgLyoqIEluaXQgaW5wdXQgKi9cbiAgQElucHV0KCkgc291cmNlPzogc3RyaW5nO1xuICAvKiogSW5pdCBpbnB1dCAqL1xuICBASW5wdXQoKSB0eXBlOiBMYXllclNwZWNpZmljYXRpb25bJ3R5cGUnXTtcbiAgLyoqIEluaXQgaW5wdXQgKi9cbiAgQElucHV0KCkgbWV0YWRhdGE/OiBMYXllclNwZWNpZmljYXRpb25bJ21ldGFkYXRhJ107XG4gIC8qKiBJbml0IGlucHV0ICovXG4gIEBJbnB1dCgpIHNvdXJjZUxheWVyPzogc3RyaW5nO1xuICAvKipcbiAgICogQSBmbGFnIHRvIGVuYWJsZSByZW1vdmVTb3VyY2UgY2xlYW4gdXAgZnVuY3Rpb25hbGl0eVxuICAgKiBcbiAgICogSW5pdCBpbnB1dFxuICAgKi9cbiAgQElucHV0KCkgcmVtb3ZlU291cmNlPzogYm9vbGVhbjtcblxuICAvKiogRHluYW1pYyBpbnB1dCAqL1xuICBASW5wdXQoKSBmaWx0ZXI/OiBGaWx0ZXJTcGVjaWZpY2F0aW9uO1xuICAvKiogRHluYW1pYyBpbnB1dCAqL1xuICBASW5wdXQoKSBsYXlvdXQ/OiBMYXllclNwZWNpZmljYXRpb25bJ2xheW91dCddO1xuICAvKiogRHluYW1pYyBpbnB1dCAqL1xuICBASW5wdXQoKSBwYWludD86IExheWVyU3BlY2lmaWNhdGlvblsncGFpbnQnXTtcbiAgLyoqIER5bmFtaWMgaW5wdXQgKi9cbiAgQElucHV0KCkgYmVmb3JlPzogc3RyaW5nO1xuICAvKiogRHluYW1pYyBpbnB1dCAqL1xuICBASW5wdXQoKSBtaW56b29tPzogTGF5ZXJTcGVjaWZpY2F0aW9uWydtaW56b29tJ107XG4gIC8qKiBEeW5hbWljIGlucHV0ICovXG4gIEBJbnB1dCgpIG1heHpvb20/OiBMYXllclNwZWNpZmljYXRpb25bJ21heHpvb20nXTtcblxuICBAT3V0cHV0KCkgbGF5ZXJDbGljayA9IG5ldyBFdmVudEVtaXR0ZXI8TWFwTGF5ZXJNb3VzZUV2ZW50ICYgRXZlbnREYXRhPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJEYmxDbGljayA9IG5ldyBFdmVudEVtaXR0ZXI8TWFwTGF5ZXJNb3VzZUV2ZW50ICYgRXZlbnREYXRhPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJNb3VzZURvd24gPSBuZXcgRXZlbnRFbWl0dGVyPE1hcExheWVyTW91c2VFdmVudCAmIEV2ZW50RGF0YT4oKTtcbiAgQE91dHB1dCgpIGxheWVyTW91c2VVcCA9IG5ldyBFdmVudEVtaXR0ZXI8TWFwTGF5ZXJNb3VzZUV2ZW50ICYgRXZlbnREYXRhPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJNb3VzZUVudGVyID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBNYXBMYXllck1vdXNlRXZlbnQgJiBFdmVudERhdGFcbiAgPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJNb3VzZUxlYXZlID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBNYXBMYXllck1vdXNlRXZlbnQgJiBFdmVudERhdGFcbiAgPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJNb3VzZU1vdmUgPSBuZXcgRXZlbnRFbWl0dGVyPE1hcExheWVyTW91c2VFdmVudCAmIEV2ZW50RGF0YT4oKTtcbiAgQE91dHB1dCgpIGxheWVyTW91c2VPdmVyID0gbmV3IEV2ZW50RW1pdHRlcjxNYXBMYXllck1vdXNlRXZlbnQgJiBFdmVudERhdGE+KCk7XG4gIEBPdXRwdXQoKSBsYXllck1vdXNlT3V0ID0gbmV3IEV2ZW50RW1pdHRlcjxNYXBMYXllck1vdXNlRXZlbnQgJiBFdmVudERhdGE+KCk7XG4gIEBPdXRwdXQoKSBsYXllckNvbnRleHRNZW51ID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBNYXBMYXllck1vdXNlRXZlbnQgJiBFdmVudERhdGFcbiAgPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJUb3VjaFN0YXJ0ID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBNYXBMYXllclRvdWNoRXZlbnQgJiBFdmVudERhdGFcbiAgPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJUb3VjaEVuZCA9IG5ldyBFdmVudEVtaXR0ZXI8TWFwTGF5ZXJUb3VjaEV2ZW50ICYgRXZlbnREYXRhPigpO1xuICBAT3V0cHV0KCkgbGF5ZXJUb3VjaENhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXI8XG4gICAgTWFwTGF5ZXJUb3VjaEV2ZW50ICYgRXZlbnREYXRhXG4gID4oKTtcblxuICBwcml2YXRlIGxheWVyQWRkZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzdWI6IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBzb3VyY2VJZEFkZGVkPzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFwU2VydmljZTogTWFwU2VydmljZSkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnN1YiA9IHRoaXMubWFwU2VydmljZS5tYXBMb2FkZWQkXG4gICAgICAucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgICAgZnJvbUV2ZW50KHRoaXMubWFwU2VydmljZS5tYXBJbnN0YW5jZSwgJ3N0eWxlZGF0YScpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKCkgPT4gZmFsc2UpLFxuICAgICAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLm1hcFNlcnZpY2UubWFwSW5zdGFuY2UuZ2V0TGF5ZXIodGhpcy5pZCkpLFxuICAgICAgICAgICAgc3RhcnRXaXRoKHRydWUpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChiaW5kRXZlbnRzOiBib29sZWFuKSA9PiB0aGlzLmluaXQoYmluZEV2ZW50cykpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICghdGhpcy5sYXllckFkZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLnBhaW50ICYmICFjaGFuZ2VzLnBhaW50LmlzRmlyc3RDaGFuZ2UoKSkge1xuICAgICAgdGhpcy5tYXBTZXJ2aWNlLnNldEFsbExheWVyUGFpbnRQcm9wZXJ0eShcbiAgICAgICAgdGhpcy5pZCxcbiAgICAgICAgY2hhbmdlcy5wYWludC5jdXJyZW50VmFsdWUhXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoY2hhbmdlcy5sYXlvdXQgJiYgIWNoYW5nZXMubGF5b3V0LmlzRmlyc3RDaGFuZ2UoKSkge1xuICAgICAgdGhpcy5tYXBTZXJ2aWNlLnNldEFsbExheWVyTGF5b3V0UHJvcGVydHkoXG4gICAgICAgIHRoaXMuaWQsXG4gICAgICAgIGNoYW5nZXMubGF5b3V0LmN1cnJlbnRWYWx1ZSFcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmZpbHRlciAmJiAhY2hhbmdlcy5maWx0ZXIuaXNGaXJzdENoYW5nZSgpKSB7XG4gICAgICB0aGlzLm1hcFNlcnZpY2Uuc2V0TGF5ZXJGaWx0ZXIodGhpcy5pZCwgY2hhbmdlcy5maWx0ZXIuY3VycmVudFZhbHVlISk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmJlZm9yZSAmJiAhY2hhbmdlcy5iZWZvcmUuaXNGaXJzdENoYW5nZSgpKSB7XG4gICAgICB0aGlzLm1hcFNlcnZpY2Uuc2V0TGF5ZXJCZWZvcmUodGhpcy5pZCwgY2hhbmdlcy5iZWZvcmUuY3VycmVudFZhbHVlISk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIChjaGFuZ2VzLm1pbnpvb20gJiYgIWNoYW5nZXMubWluem9vbS5pc0ZpcnN0Q2hhbmdlKCkpIHx8XG4gICAgICAoY2hhbmdlcy5tYXh6b29tICYmICFjaGFuZ2VzLm1heHpvb20uaXNGaXJzdENoYW5nZSgpKVxuICAgICkge1xuICAgICAgdGhpcy5tYXBTZXJ2aWNlLnNldExheWVyWm9vbVJhbmdlKHRoaXMuaWQsIHRoaXMubWluem9vbSwgdGhpcy5tYXh6b29tKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5sYXllckFkZGVkKSB7XG4gICAgICB0aGlzLm1hcFNlcnZpY2UucmVtb3ZlTGF5ZXIodGhpcy5pZCk7XG4gICAgICBpZiAodW5kZWZpbmVkICE9PSB0aGlzLnNvdXJjZUlkQWRkZWQpIHtcbiAgICAgICAgLy8gQ2xlYW4gdXAgYW55IGF1dG9tYXRpY2FsbHkgY3JlYXRlZCBzb3VyY2UgZm9yIHRoaXMgbGF5ZXJcbiAgICAgICAgaWYgKHRoaXMubWFwU2VydmljZS5nZXRTb3VyY2UodGhpcy5zb3VyY2VJZEFkZGVkKSkge1xuICAgICAgICAgIHRoaXMubWFwU2VydmljZS5yZW1vdmVTb3VyY2UodGhpcy5zb3VyY2VJZEFkZGVkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zdWIpIHtcbiAgICAgIHRoaXMuc3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0KGJpbmRFdmVudHM6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsYXllcjogU2V0dXBMYXllciA9IHtcbiAgICAgIGxheWVyT3B0aW9uczoge1xuICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgdHlwZTogdGhpcy50eXBlLFxuICAgICAgICBzb3VyY2U6IHRoaXMuc291cmNlIGFzIHN0cmluZyxcbiAgICAgICAgbWV0YWRhdGE6IHRoaXMubWV0YWRhdGEsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb25cbiAgICAgICAgJ3NvdXJjZS1sYXllcic6IHRoaXMuc291cmNlTGF5ZXIsXG4gICAgICAgIG1pbnpvb206IHRoaXMubWluem9vbSxcbiAgICAgICAgbWF4em9vbTogdGhpcy5tYXh6b29tLFxuICAgICAgICBmaWx0ZXI6IHRoaXMuZmlsdGVyLFxuICAgICAgICBsYXlvdXQ6IHRoaXMubGF5b3V0LFxuICAgICAgICBwYWludDogdGhpcy5wYWludCxcbiAgICAgIH0gYXMgTGF5ZXJTcGVjaWZpY2F0aW9uLFxuICAgICAgbGF5ZXJFdmVudHM6IHtcbiAgICAgICAgbGF5ZXJDbGljazogdGhpcy5sYXllckNsaWNrLFxuICAgICAgICBsYXllckRibENsaWNrOiB0aGlzLmxheWVyRGJsQ2xpY2ssXG4gICAgICAgIGxheWVyTW91c2VEb3duOiB0aGlzLmxheWVyTW91c2VEb3duLFxuICAgICAgICBsYXllck1vdXNlVXA6IHRoaXMubGF5ZXJNb3VzZVVwLFxuICAgICAgICBsYXllck1vdXNlRW50ZXI6IHRoaXMubGF5ZXJNb3VzZUVudGVyLFxuICAgICAgICBsYXllck1vdXNlTGVhdmU6IHRoaXMubGF5ZXJNb3VzZUxlYXZlLFxuICAgICAgICBsYXllck1vdXNlTW92ZTogdGhpcy5sYXllck1vdXNlTW92ZSxcbiAgICAgICAgbGF5ZXJNb3VzZU92ZXI6IHRoaXMubGF5ZXJNb3VzZU92ZXIsXG4gICAgICAgIGxheWVyTW91c2VPdXQ6IHRoaXMubGF5ZXJNb3VzZU91dCxcbiAgICAgICAgbGF5ZXJDb250ZXh0TWVudTogdGhpcy5sYXllckNvbnRleHRNZW51LFxuICAgICAgICBsYXllclRvdWNoU3RhcnQ6IHRoaXMubGF5ZXJUb3VjaFN0YXJ0LFxuICAgICAgICBsYXllclRvdWNoRW5kOiB0aGlzLmxheWVyVG91Y2hFbmQsXG4gICAgICAgIGxheWVyVG91Y2hDYW5jZWw6IHRoaXMubGF5ZXJUb3VjaENhbmNlbCxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBpZiAodGhpcy5yZW1vdmVTb3VyY2UgJiYgdHlwZW9mIHRoaXMuc291cmNlICE9PSAnc3RyaW5nJykge1xuICAgICAgLy8gVGhlcmUgaXMgbm8gaWQgb2YgYW4gZXhpc3Rpbmcgc291cmNlIGJvdW5kIHRvIHRoaXMgbGF5ZXJcbiAgICAgIGlmICh1bmRlZmluZWQgPT09IHRoaXMubWFwU2VydmljZS5nZXRTb3VyY2UodGhpcy5pZCkpIHtcbiAgICAgICAgLy8gQSBzb3VyY2Ugd2l0aCB0aGlzIGxheWVyIGlkIGRvZXNuJ3QgZXhpc3Qgc28gaXQgd2lsbCBiZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgaW4gdGhlIGFkZExheWVyIGNhbGwgYmVsb3dcbiAgICAgICAgdGhpcy5zb3VyY2VJZEFkZGVkID0gdGhpcy5pZDtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5tYXBTZXJ2aWNlLmFkZExheWVyKGxheWVyLCBiaW5kRXZlbnRzLCB0aGlzLmJlZm9yZSk7XG4gICAgaWYgKHVuZGVmaW5lZCAhPT0gdGhpcy5zb3VyY2VJZEFkZGVkKSB7XG4gICAgICBpZiAodW5kZWZpbmVkID09PSB0aGlzLm1hcFNlcnZpY2UuZ2V0U291cmNlKHRoaXMuc291cmNlSWRBZGRlZCkpIHtcbiAgICAgICAgLy8gSWYgaXQgd2Fzbid0IGNyZWF0ZWQgZm9yIHNvbWUgcmVhc29uIHRoZW4gd2UgZG9uJ3Qgd2FudCB0byBjbGVhbiBpdCB1cFxuICAgICAgICB0aGlzLnNvdXJjZUlkQWRkZWQgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMubGF5ZXJBZGRlZCA9IHRydWU7XG4gIH1cbn1cbiJdfQ==